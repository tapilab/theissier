<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
    <link rel="stylesheet" href="stylesheets/bootstrap.min.css"/>
    <link rel="stylesheet" href="stylesheets/style.css"/>
    <link rel="stylesheet" type="text/css" href="stylesheets/highslide.css"/>
</head>
<body>
    <legend>
        <button id="modal-button" class="btn btn-primary btn-small" data-toggle="modal" data-target="#info-box">Info!</button>
        <button id="analytics" class="btn btn-success btn-small" data-toggle="modal" data-target="#analytics-box">Analytics</button>
        <div id="search-keyword">
            <form class = "navbar-form navbar-brand" role="search">
                <div class="form-group">
                    <input id="keyword-search-input" class="form-control" name="search_query" type="text" placeholder="Search"/>
                </div>
                <button id="submit-keyword" type="button" class="btn btn-default btn-sm">
                    <span class="glyphicon glyphicon-search"></span>
                </button>
            </form>
        </div>
        <div id="choose-session" class="btn-group">
            <button id="choose-session-button" class="btn btn-default btn-small btn-danger dropdown-toggle" type="button" data-toggle="dropdown">
                Sessions <span class="caret"></span>
            </button>
            <ul id="list-sessions" class="dropdown-menu">
                <li id="no-history" class="disabled"><a href="#">No History</a></li>
            </ul>
        </div>
        <button id="create-session-button" class="btn btn-success btn-small" data-toggle="modal" data-target="#create-session-box">Create a session</button>
        <br/><br/>
    </legend>
    <div class="modal fade" id="analytics-box" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                    <h4 class="modal-title" id="analytics-title">Information</h4>
                </div>
                <div id="text-analytics-box" class="modal-body">
                    <div id="container" style="min-width: 310px; height: 400px; margin: 0 auto"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                    <!-- <button type="button" class="btn btn-primary">Save changes</button> -->
                </div>
            </div><!-- /.modal-content -->
        </div><!-- /.modal-dialog -->
    </div><!-- /.modal -->
    <div class="modal fade" id="info-box" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                    <h4 class="modal-title" id="info">Information</h4>
                </div>
                <div id="text-info-box" class="modal-body">
                    <p>Just search for something (keywords or sentences) and say if the tweets retrieved are relevant to your search!</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                    <!-- <button type="button" class="btn btn-primary">Save changes</button> -->
                </div>
            </div><!-- /.modal-content -->
        </div><!-- /.modal-dialog -->
    </div><!-- /.modal -->
    <div class="modal fade" id="modal-box" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                    <h4 class="modal-title" id="tweets-result">Tweets</h4>
                </div>
                <div id="text-modal" class="modal-body">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                   <!-- <button type="button" class="btn btn-primary">Save changes</button> -->
                </div>
            </div><!-- /.modal-content -->
        </div><!-- /.modal-dialog -->
    </div><!-- /.modal -->
    <div class="modal fade" id="create-session-box" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                    <h4 class="modal-title" id="title-create-session">Create a session</h4>
                </div>
                <div id="body-create-session" class="modal-body">
                    <form class="form-horizontal" role="form">
                        <div class="form-group">
                            <div class="input-group">
                                <span class="input-group-addon">@</span>
                                <input id="input-username" type="text" class="form-control" placeholder="Username">
                            </div>
                        </div>
                        <div class="form-group">
                            <input type="text" class="form-control" id="input-session-name" placeholder="Your Session Name">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button id="submit-create-session" type="button" class="disabled btn btn-primary" data-dismiss="modal">Submit</button>
                    <!-- <button type="button" class="btn btn-primary">Save changes</button> -->
                </div>
            </div><!-- /.modal-content -->
        </div><!-- /.modal-dialog -->
    </div><!-- /.modal -->
        <div id="map-canvas"/>
    </div>
</body>
    <script src="http://localhost:8080/socket.io/socket.io.js"></script>
    <script>
        var socket = io.connect('http://localhost:8080');
    </script>
    <script type="text/javascript" src="//code.jquery.com/jquery-1.10.2.min.js"></script>
    <script type="text/javascript"
            src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAXmKFXOfbzFxjrP5BO-Jw8ZTtooWm0XKU&sensor=true">
    </script>
    <script type="text/javascript" src="javascripts/bootstrap.min.js"></script>
    <script type="text/javascript" src="javascripts/underscore.js"></script>
    <script type="text/javascript" src="javascripts/backbone.js"></script>
    <script type="text/javascript" src="javascripts/highcharts.js"></script>
    <script type="text/javascript" src="javascripts/data.js"></script>
    <script type="text/javascript" src="javascripts/exporting.js"></script>
    <script type="text/javascript" src="javascripts/initChart.js"></script>
    <script type="text/javascript">
        var Search = Backbone.Model.extend({
            defaults: {
                input: "Keyword",
                hits: new Object()
            },
            initialize: function(){
                //console.log("Search is initialized");
            }
        });

        var SearchResults = Backbone.Collection.extend({
            model: Search
        });

        var results = new SearchResults();
       // console.log( results.models );
    </script>
    <script type="text/javascript">
        //heroku declaration of socket client !
       /* var host = location.origin.replace(/^http/, 'wss');
        console.log(host);
        var ws = new WebSocket(host);   */
        var map;
        var markers = [];
        var infoWindows = [];
        var returnHits =[];
        function initialize() {
            var mapOptions = {
                zoom: 2,
                center: new google.maps.LatLng(10, 0)
            };
            map = new google.maps.Map(document.getElementById('map-canvas'), mapOptions);
            socket.on('data', function(hits) {
                clearMarkers();
                markers = [];
                infoWindows = [];
                $("#text-modal").empty();
                if (hits != '') {
                    $('#modal-box').modal('hide');
                    for (var index in hits) {
                        var search = new Search();
                        search.set('input',$("#keyword-search-input").val());
                        var hit = new Object();
                        hit.id = hits[index]._id;
                        hit.username = hits[index]._source.user.name;
                        hit.created_at = hits[index]._source.created_at;
                        hit.text = hits[index]._source.text;
                        hit.lng = hits[index]._source.geo.coordinates[0];
                        hit.lat = hits[index]._source.geo.coordinates[1];
                        hit.score = -1;
                        hit.session = $("#choose-session").val();

                        var idInfoWindow = 'contentInfoWindow' + hit['id'];
                        var usernameAndTweet = "<div id=" + idInfoWindow + "><div class='tweets-matched'><h3>" + hit['username'] + "</h3><h5>"+ hit['created_at'] +"</h5><p>"+ hit['text'] +"</p></div>";
                        var myLatlng = new google.maps.LatLng(hit['lng'], hit['lat']);
                        var infoWindow = new google.maps.InfoWindow({
                            content: usernameAndTweet
                        });
                        infoWindows.push(infoWindow);
                        var marker = new google.maps.Marker({
                            position: myLatlng,
                            map: map,
                            title: usernameAndTweet
                        });
                        markers.push(marker);
                        google.maps.event.addListener(markers[index], 'click', function(innerKey) {
                            return function() {
                                infoWindows[innerKey].open(map, markers[innerKey]);
                            }
                        }(index));

                        $('#text-modal').append(usernameAndTweet);
                        var idSelector = "#" + idInfoWindow;
                        var idButtons = "id-button-" + index;
                        $(idSelector).append("<div id=" + idButtons + " class='yes-or-no'><button type='button' class='button-yes btn btn-success'><span class='glyphicon glyphicon-ok-sign'></span> Yes!</button><br/><button type='button' class='button-no btn btn-danger'><span class='glyphicon glyphicon-remove-sign'></span> Nope!</button></div></div>");
                        $(idSelector).css('overflow', 'hidden');
                        $(idSelector).css('margin-top', '20px');
                        search.set('hits', hit);
                        results.add(search);

                        $("#" + idButtons + " .button-yes").click(function() {
                            var idParent = $(this).parents().parents().attr('id');
                            var indexHit = idParent.replace('contentInfoWindow','');
                            var indexCollection = findIndex(indexHit, results);
                            var hitsToSave = results.models[indexCollection].attributes.hits;
                            hitsToSave.score = 1;
                            var updateObjectScore = new Search;
                            results.remove(results.at(indexCollection));
                            updateObjectScore.set('input', $('#keyword-search-input').val());
                            updateObjectScore.set('hits', hitsToSave);
                            results.push(updateObjectScore, {at: indexCollection});
                            socket.emit('affectGoodScore', {object: hitsToSave});

                        });
                        $("#" + idButtons + " .button-no").click(function() {
                            var idParent = $(this).parents().parents().attr('id');
                            var indexHit = idParent.replace('contentInfoWindow','');
                            var indexCollection = findIndex(indexHit, results);
                            var hitsToSave = results.models[indexCollection].attributes.hits;
                            hitsToSave.score = 0;
                            var updateObjectScore = new Search;
                            results.remove(results.at(indexCollection));
                            updateObjectScore.set('input', $('#keyword-search-input').val());
                            updateObjectScore.set('hits', hitsToSave);
                            results.push(updateObjectScore, {at: indexCollection});
                            socket.emit('affectBadScore', {object:hitsToSave});
                        });
                    }
                    setAllMap(map);
                    $('#modal-box').modal('toggle');
                } else {
                    $('#text-modal').append("<p>No tweets are relative to this research</p>");
                    $('#modal-box').modal('toggle');
                }
            });
        }

        /**** FUNCTIONS MARKERS GOOGLEMAPS ****/
        function setAllMap(map) {
            for (var i = 0; i < markers.length; i++) {
                markers[i].setMap(map);
            }
        }
        function clearMarkers() {
            setAllMap(null);
        }

        function findIndex(index, collection) {
            for (var i=0; i < collection.models.length; i++) {
                if (collection.models[i].attributes.hits.id == index) {
                     return i;
                }
            }

        }

        google.maps.event.addDomListener(window, 'load', initialize);

          /* HEROKU SOCKET */
            /*
            ws.onmessage = function (event) {
                var data = JSON.parse(event.data);
                console.log(data);
                var usernameAndTweet = "<div id='contentInfoWindow'><h3>" + data.user.name + "</h3><h5>"+ data.created_at +"</h5><p>"+ data.text +"</p></div>";
                var myLatlng = new google.maps.LatLng(data.geo.coordinates[0],data.geo.coordinates[1]);
                var infowindow = new google.maps.InfoWindow({
                    content: usernameAndTweet
                });
                var marker = new google.maps.Marker({
                    position: myLatlng,
                    map: map,
                    title: usernameAndTweet
                });
                google.maps.event.addListener(marker, 'click', function() {
                    infowindow.open(map,marker);
                });
            }
        }     */
    </script>
    <script type="text/javascript" src="javascripts/base.js"></script>
</html>